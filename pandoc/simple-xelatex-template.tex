\documentclass[12pt,a4paper]{book}

% --- Fonts & Sprache (XeLaTeX) ---
\usepackage{fontspec}
\usepackage{polyglossia}
\setmainlanguage{german}
$if(mainfont)$
\setmainfont{$mainfont$}[Ligatures=TeX]
$else$
\setmainfont{Latin Modern Roman}[Ligatures=TeX]
$endif$
$if(sansfont)$
\setsansfont{$sansfont$}[Ligatures=TeX]
$else$
\setsansfont{Latin Modern Sans}[Ligatures=TeX]
$endif$
$if(monofont)$
\setmonofont{$monofont$}[Ligatures=TeX]
$else$
\setmonofont{Latin Modern Mono}[Ligatures=TeX]
$endif$

% --- Layout ---
\usepackage{geometry}
\geometry{margin=2.5cm}
\usepackage{setspace}
\setstretch{1.2}
% Absatzabstände explizit auf 0 setzen, da Markdown bereits Leerzeilen zwischen Absätzen hat
\setlength{\parskip}{0pt}

% --- Text-Formatierung ---
\usepackage[normalem]{ulem}  % Für \sout (durchgestrichener Text) - normalem verhindert Überschreibung von \emph
\usepackage{soul}  % Für \hl (Hervorhebungen)
\usepackage{graphicx}  % Für Bilder


% --- Überschriften ---
\usepackage{titlesec}
% Sections (H1) sollen auf neuen Seiten beginnen, aber ohne zusätzliche Leerseiten
\titleformat{\section}
  {\normalfont\Large\bfseries}
  {}
  {0em}
  {}
  {}  % Kein \clearpage hier, wird separat gehandhabt
\titlespacing*{\section}{0pt}{3.5ex plus 1ex minus .2ex}{2.3ex plus .2ex}
\titleformat{\subsection}{\normalfont\large\bfseries}{}{0em}{}

% --- Nummerierung komplett deaktivieren ---
\setcounter{secnumdepth}{0}  % Keine Nummerierung für Sections, Subsections, etc.

% --- Seitenumbruch vor Sections (H1) ---
% Sicherstellen, dass Sections immer auf neuen Seiten beginnen
\usepackage{etoolbox}
\makeatletter
\pretocmd{\section}{\clearpage}{}{}
\makeatother

% --- Initialen (Drop Caps) Styling ---
\usepackage{lettrine}
% Grundstil für alle Initialen (vom Lua-Filter gesetzt)
\renewcommand{\LettrineTextFont}{\bfseries\color{black}}
\renewcommand{\LettrineFont}{\fontsize{48}{48}\selectfont\bfseries} % etwas kleiner
\setlength{\DefaultNindent}{0.3em}   % linker Einzug
\setlength{\DefaultFindent}{0.2em}   % Abstand Initiale/Text
\setcounter{DefaultLines}{3}         % über 3 Zeilen
\renewcommand{\DefaultLraise}{0.2}   % leicht angehoben
\renewcommand{\DefaultLoversize}{0.12} % etwas kompakter

% --- Pandoc-kompatible Pakete ---
\usepackage{longtable,booktabs,array,calc,colortbl,multirow,hhline,ifthen,ltxtable}
\usepackage{graphicx,grffile,textcomp,amsmath,amssymb,url,listings,fancyvrb,footnote}
% parskip NICHT verwenden - Markdown hat bereits Leerzeilen zwischen Absätzen
% \usepackage[parfill]{parskip}  % Deaktiviert - würde zusätzliche Abstände erzeugen
% xcolor für Shaded Environment
\usepackage{xcolor}

% Shaded Environment explizit definieren (für Code-Blöcke ohne Syntax-Highlighting)
\definecolor{Shaded}{RGB}{245,245,245}
\newenvironment{Shaded}{%
  \VerbatimEnvironment
  \begin{Verbatim}[fontsize=\small]%
}{%
  \end{Verbatim}%
}

% Highlighting Environment für Code-Blöcke mit Syntax-Highlighting
% Pandoc verwendet dieses Environment für Code-Blöcke mit Syntax-Highlighting
% Die Highlighting-Befehle müssen definiert werden, damit sie funktionieren
% Highlighting-Befehle für Syntax-Highlighting (Pandoc-Stil)
\newcommand{\NormalTok}[1]{\textcolor[RGB]{0,0,0}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[RGB]{112,128,144}{\textit{#1}}}
\newcommand{\KeywordTok}[1]{\textcolor[RGB]{0,0,255}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[RGB]{0,0,255}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[RGB]{0,0,128}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[RGB]{0,0,128}{#1}}
\newcommand{\FloatTok}[1]{\textcolor[RGB]{0,0,128}{#1}}
\newcommand{\CharTok}[1]{\textcolor[RGB]{0,163,163}{#1}}
\newcommand{\StringTok}[1]{\textcolor[RGB]{163,21,21}{#1}}
\newcommand{\ConstantTok}[1]{\textcolor[RGB]{111,0,138}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[RGB]{163,21,21}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[RGB]{163,21,21}{#1}}
\newcommand{\SpecialCharTok}[1]{\textcolor[RGB]{0,163,163}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\DocumentationTok}[1]{\textcolor[RGB]{112,128,144}{\textit{#1}}}
\newcommand{\AnnotationTok}[1]{\textcolor[RGB]{37,148,148}{\textbf{\textit{#1}}}}
\newcommand{\CommentVarTok}[1]{\textcolor[RGB]{112,128,144}{\textbf{\textit{#1}}}}
\newcommand{\OtherTok}[1]{\textcolor[RGB]{0,0,0}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[RGB]{0,0,255}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[RGB]{0,0,0}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[RGB]{0,0,255}{\textbf{#1}}}
\newcommand{\OperatorTok}[1]{\textcolor[RGB]{0,0,0}{\textbf{#1}}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\PreprocessorTok}[1]{\textcolor[RGB]{128,128,128}{\textit{#1}}}
\newcommand{\AttributeTok}[1]{\textcolor[RGB]{128,0,0}{#1}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[RGB]{112,128,144}{\textbf{\textit{#1}}}}
\newcommand{\WarningTok}[1]{\textcolor[RGB]{112,128,144}{\textbf{#1}}}
\newcommand{\AlertTok}[1]{\textcolor[RGB]{255,0,0}{\textbf{#1}}}
\newcommand{\ErrorTok}[1]{\textcolor[RGB]{255,0,0}{\textbf{#1}}}

% Highlighting Environment - verwendet Verbatim mit kleinerer Schrift
\newenvironment{Highlighting}[1][]{%
  \VerbatimEnvironment
  \begin{Verbatim}[commandchars=\\\{\}, fontsize=\small, breaklines=true]%
}{%
  \end{Verbatim}%
}

% Abstract Environment für book-Klasse manuell definieren
\newenvironment{abstract}{%
  \small
  \begin{center}%
    {\bfseries Zusammenfassung\vspace{0.5em}\vspace{0pt}}%
  \end{center}%
  \quotation
}{%
  \endquotation
}

% --- Links ---
\usepackage{hyperref}
\hypersetup{colorlinks=true, linkcolor=black, urlcolor=blue}

% --- Pandoc-spezifische Befehle ---
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

% Normalisiere Absatzabstände
% Verhindere, dass LaTeX Abstände zu stark streckt
\raggedbottom
% Pandoc-Befehl für begrenzte Bilder
% \pandocbounded wird mit einem Argument aufgerufen, das bereits \includegraphics enthält
% Beispiel: \pandocbounded{\includegraphics[keepaspectratio]{bild.png}}
% Zentriere das Bild ohne Seitenumbrüche
\newcommand{\pandocbounded}[1]{%
  \par
  \nopagebreak
  \begin{center}%
  #1%
  \end{center}%
  \nopagebreak
  \par
}
% Zentriere alle includegraphics-Befehle im Text
% Verhindere Seitenumbrüche vor und nach Bildern
\makeatletter
\let\oldincludegraphics\includegraphics
\renewcommand{\includegraphics}[2][]{%
  \par
  \nopagebreak
  \begin{center}%
  \oldincludegraphics[#1]{#2}%
  \end{center}%
  \nopagebreak
  \par
}
\makeatother

% --- Inhaltsverzeichnis ohne Nummern ---
\makeatletter
\renewcommand{\@seccntformat}[1]{}
\makeatother

% --- Inhaltsverzeichnis: H1 und H2 anzeigen ---
% tocdepth=2 bedeutet H1 (sections) und H2 (subsections)
\setcounter{tocdepth}{2}

% TOC-Titel entfernen oder formatieren
\makeatletter
\renewcommand{\@tocrmarg}{2.55em plus 1fil}
\renewcommand{\@dotsep}{4.5}
\makeatother

\begin{document}

% --- Cover-Bild (eigene Seite) ---
$if(cover-image)$
\begin{titlepage}
  \centering
  \vspace*{\fill}
  \includegraphics[width=0.6\textwidth,keepaspectratio]{$cover-image$}
  \vspace*{\fill}
\end{titlepage}
$endif$

% --- Titelseite ---
\begin{titlepage}
  \centering
  \vspace*{2cm}
  {\Huge \bfseries $title$ \par}
  \vspace{0.5cm}
  $if(subtitle)$
  {\Large \textit{$subtitle$} \par}
  \vspace{2cm}
  $else$
  \vspace{2.5cm}
  $endif$
  {\Large $author$ \par}
  \vspace{1.5cm}
  {\large $date$ \par}
  $if(rights)$
  \vspace{2cm}
  {\small $rights$ \par}
  $endif$
  \vfill
\end{titlepage}
\newpage

% --- Abstract ---
$if(abstract)$
\begin{abstract}
$abstract$
\end{abstract}
\newpage
$endif$

% --- Inhaltsverzeichnis ---
$if(toc)$
\begingroup
% TOC-Titel entfernen (falls vorhanden)
\let\oldcontentsname\contentsname
\renewcommand{\contentsname}{}
\tableofcontents
\let\contentsname\oldcontentsname
\endgroup
\newpage
$endif$

% --- Inhalt ---
$body$

\end{document}
